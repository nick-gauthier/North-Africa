---
title: "North_Africa_landcover"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(raster)
library(rasterVis)
library(tidyverse)
library(mgcv)
library(SPEI)
```

```{r}
bbox <- extent(-10, 20, 28, 38)

temp <- brick('Data/CHELSA/temp.nc') %>% crop(bbox)
t_warm <- max(temp)
t_cold <- min(temp)
alpha <- raster('Data/CHELSA/alpha.nc') %>% crop(bbox)
gdd5 <- raster('gdd5_global.tif') %>% crop(bbox)

modern_predictors <- brick(c(t_warm, t_cold, alpha,gdd5))
names(modern_predictors) <- c('t_warm', 't_cold', 'alpha', 'gdd5')
rm(temp, t_warm, t_cold, alpha, gdd5)

plot(modern_predictors)
```

Load a ppreviously fitted gam model
```{r}
veg_gam <- readRDS('mod2')
mod_predictions <- predict(modern_predictors, veg_gam, type = 'response', index = 1:9)

uncertainty <- mod_predictions %>% 
  as.data.frame(na.rm = T, xy = T) %>%
  gather(var, val, 3:11) %>%
  group_by(x, y) %>%
  summarise(p1 = max(val), p2 = max(val[val != p1])) %>%
  mutate(ui = (p1 - p2) / p1)

lc_mod <- mod_predictions%>% 
  which.max %>% 
  as.data.frame(na.rm = T, xy = T) %>% 
  mutate(class = recode_factor(as.factor(layer),
                               `6` = 'Temperate forest',
                               `9` = 'Warm-temperate forest',
                               `4` = 'Grassland and dry shrubland',
                               `3` = 'Desert (vegetated)',
                               `1` = 'Desert (bare)', .default = 'Temperate forest'  # there a a handful of pixels with other types not visibleonthe mapsscale, replace with temperate forest for clarity as these pixels all are found in these areas
                           ))  %>%
  left_join(uncertainty)



lc_colors <- c('#016400', '#018200', '#97bf47','#dcce00',  '#fffbc3')

ggplot(lc_mod, aes(x, y)) + 
  geom_tile(aes(alpha = ui, fill = class)) + 
  scale_fill_manual(values = lc_colors) + 
  theme_void() + 
  coord_fixed()
```


Now do the same for the mid holocene
```{r}
tmin <- brick('~/gdrive/Projects/MedinesR/Downscaled/ensemble_tmn_mh6k.tif') %>% crop(bbox)
tmax <- brick('~/gdrive/Projects/MedinesR/Downscaled/ensemble_tmx_mh6k.tif') %>% crop(bbox)
prec <- brick('~/gdrive/Projects/MedinesR/Downscaled/ensemble_prc_mh6k.tif') %>% crop(bbox)

srad <- list.files('~/Downloads/CGIAR PET/ET_SolRad', full.names = T) %>%
  stack %>%
  crop(bbox) %>%
  raster::resample(prec) %>%
  crop(bbox) %>%
  .[[c(1,5:12, 2:4)]] %>%
  `*`(2.45) #convert to mj/m2/day

pet <- hargreaves(tmin %>% getValues %>% t, 
                  tmax %>% getValues %>% t, 
                  Ra = srad %>% getValues %>% t, 
                  Pre = prec %>% getValues %>% t, na.rm = T) %>%
  t %>%
  setValues(tmin, .)

swc <- setValues(pet[[1]], 100) %>% mask(pet[[1]])
aet.brick <- setValues(pet, 0) %>% mask(pet[[1]])

for(a in 1:10){
  for(i in 1:12){
    ksoil <- swc / 350
    aet <- pet[[i]] * ksoil
    aet.brick[[i]] <- aet
    swc.tmp <- swc + prec[[i]] * (1 - .15) - aet
    swc <- reclassify(swc.tmp, c(-Inf, 0, 0, 350, Inf, 350))
  }
}

alpha <- sum(aet.brick) / sum(pet)

temp <- (tmax + tmin) / 2
t_warm <- max(temp)
t_cold <- min(temp)

gdd5_interp <- function(x){
  if(any(is.na(x))){return(NA)} else{
    daily <- gam(x ~ s(doy, bs = 'cc', k = 12), knots = list(doy = c(1, 366))) %>%
      predict.gam(data.frame(doy = 1:365)) 
    daily[daily < 5] <- 5
    return(sum(daily - 5))
  }
}

doy <-c(15, 46, 74, 105, 135, 166, 196, 227, 258, 288, 319, 349)

beginCluster(4)
gdd5 <- clusterR(temp, calc, args = list(fun = gdd5_interp), export = 'doy')
endCluster()

mh_predictors <- brick(c(t_warm, t_cold, alpha,gdd5))
names(mh_predictors) <- c('t_warm', 't_cold', 'alpha', 'gdd5')
rm(prec, tmin, tmax, pet, ksoil, aet, aet.brick, swc.tmp, swc, srad, temp, t_warm, t_cold, alpha, gdd5)

plot(mh_predictors)
```

```{r}
lc_mh <- predict(mh_predictors, veg_gam, type = 'response', index = 1:9) %>% 
  which.max %>% 
  as.data.frame(na.rm = T, xy = T) %>% 
  mutate(class = recode_factor(as.factor(layer),
                               `6` = 'Temperate forest',
                               `9` = 'Warm-temperate forest',
                               `4` = 'Grassland and dry shrubland',
                               `3` = 'Desert (vegetated)',
                               `1` = 'Desert (bare)', .default = 'Temperate forest'  # there are a handful of pixels with other types not visibleonthe mapsscale, replace with temperate forest for clarity as these pixels all are found in these areas
                           ))

lc_colors <- c('#016400', '#018200', '#97bf47','#dcce00',  '#fffbc3')

ggplot(lc_mh, aes(x, y)) + 
  geom_tile(aes(fill = class)) + 
  scale_fill_manual(values = lc_colors) + 
  theme_void() + 
  coord_fixed()
```


