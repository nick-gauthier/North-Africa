---
title: "North_Africa_landcover"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(raster)
library(rasterVis)
library(tidyverse)
library(mgcv)
library(SPEI)
library(fields)
```

```{r}
bbox <- extent(-10, 20, 28, 38)

temp <- brick('Data/CHELSA/temp.nc') %>% crop(bbox)
t_warm <- max(temp)
t_cold <- min(temp)
alpha <- raster('Data/CHELSA/alpha.nc') %>% crop(bbox)
gdd5 <- raster('gdd5_global.tif') %>% crop(bbox)

modern_predictors <- brick(c(t_warm, t_cold, alpha,gdd5))
names(modern_predictors) <- c('t_warm', 't_cold', 'alpha', 'gdd5')
rm(temp, t_warm, t_cold, alpha, gdd5)

plot(modern_predictors)
```

Load a ppreviously fitted gam model
```{r}
veg_gam <- readRDS('mod2')
mod_predictions <- predict(modern_predictors, veg_gam, type = 'response', index = 1:9)

uncertainty <- mod_predictions %>% 
  as.data.frame(na.rm = T, xy = T) %>%
  gather(var, val, 3:11) %>%
  group_by(x, y) %>%
  summarise(p1 = max(val), p2 = max(val[val != p1])) %>%
  mutate(ui = (p1 - p2) / p1)

lc_mod <- mod_predictions%>% 
  which.max %>% 
  as.data.frame(na.rm = T, xy = T) %>% 
  mutate(class = recode_factor(as.factor(layer),
                               `6` = 'Temperate forest',
                               `9` = 'Warm-temperate forest',
                               `4` = 'Grassland and dry shrubland',
                               `3` = 'Desert (vegetated)',
                               `1` = 'Desert (bare)', .default = 'Temperate forest'  # there a a handful of pixels with other types not visibleonthe mapsscale, replace with temperate forest for clarity as these pixels all are found in these areas
                           ))  %>%
  left_join(uncertainty)



lc_colors <- c('#016400', '#018200', '#97bf47','#dcce00',  '#fffbc3')

ggplot(lc_mod, aes(x, y)) + 
  geom_tile(aes(alpha = ui, fill = class)) + 
  scale_fill_manual(values = lc_colors) + 
  theme_void() + 
  coord_fixed()
```


Now do the same for the mid holocene
```{r}
tmin <- brick('~/gdrive/Projects/MedinesR/Downscaled/ensemble_tmn_mh6k.tif') %>% crop(bbox)
tmax <- brick('~/gdrive/Projects/MedinesR/Downscaled/ensemble_tmx_mh6k.tif') %>% crop(bbox)
prec <- brick('~/gdrive/Projects/MedinesR/Downscaled/ensemble_prc_mh6k.tif') %>% crop(bbox)

srad <- list.files('~/Downloads/CGIAR PET/ET_SolRad', full.names = T) %>%
  stack %>%
  crop(bbox) %>%
  raster::resample(prec) %>%
  crop(bbox) %>%
  .[[c(1,5:12, 2:4)]] %>%
  `*`(2.45) #convert to mj/m2/day

pet <- hargreaves(tmin %>% getValues %>% t, 
                  tmax %>% getValues %>% t, 
                  Ra = srad %>% getValues %>% t, 
                  Pre = prec %>% getValues %>% t, na.rm = T) %>%
  t %>%
  setValues(tmin, .)

swc <- setValues(pet[[1]], 100) %>% mask(pet[[1]])
aet.brick <- setValues(pet, 0) %>% mask(pet[[1]])

for(a in 1:10){
  for(i in 1:12){
    ksoil <- swc / 350
    aet <- pet[[i]] * ksoil
    aet.brick[[i]] <- aet
    swc.tmp <- swc + prec[[i]] * (1 - .15) - aet
    swc <- reclassify(swc.tmp, c(-Inf, 0, 0, 350, Inf, 350))
  }
}

alpha <- sum(aet.brick) / sum(pet)

temp <- (tmax + tmin) / 2
t_warm <- max(temp)
t_cold <- min(temp)

gdd5_interp <- function(x){
  if(any(is.na(x))){return(NA)} else{
    daily <- gam(x ~ s(doy, bs = 'cc', k = 12), knots = list(doy = c(1, 366))) %>%
      predict.gam(data.frame(doy = 1:365)) 
    daily[daily < 5] <- 5
    return(sum(daily - 5))
  }
}

doy <-c(15, 46, 74, 105, 135, 166, 196, 227, 258, 288, 319, 349)

beginCluster(4)
gdd5 <- clusterR(temp, calc, args = list(fun = gdd5_interp), export = 'doy')
endCluster()

mh_predictors <- brick(c(t_warm, t_cold, alpha,gdd5))
names(mh_predictors) <- c('t_warm', 't_cold', 'alpha', 'gdd5')
rm(prec, tmin, tmax, pet, ksoil, aet, aet.brick, swc.tmp, swc, temp, t_warm, t_cold, alpha, gdd5)

plot(mh_predictors)
```

```{r}
lc_mh <- predict(mh_predictors, veg_gam, type = 'response', index = 1:9) %>% 
  which.max %>% 
  as.data.frame(na.rm = T, xy = T) %>% 
  mutate(class = recode_factor(as.factor(layer),
                               `6` = 'Temperate forest',
                               `9` = 'Warm-temperate forest',
                               `4` = 'Grassland and dry shrubland',
                               `3` = 'Desert (vegetated)',
                               `1` = 'Desert (bare)', .default = 'Temperate forest'  # there are a handful of pixels with other types not visibleonthe mapsscale, replace with temperate forest for clarity as these pixels all are found in these areas
                           ))

lc_colors <- c('#016400', '#018200', '#97bf47','#dcce00',  '#fffbc3')

ggplot(lc_mh, aes(x, y)) + 
  geom_tile(aes(fill = class)) + 
  scale_fill_manual(values = lc_colors) + 
  theme_void() + 
  coord_fixed()
```



## whats the difference between climate models
```{r}
prec <- brick('Data/CHELSA/prec.nc') %>% crop(bbox)
tmin <- brick('Data/CHELSA/tmin.nc') %>% crop(bbox)
tmax <- brick('Data/CHELSA/tmax.nc') %>% crop(bbox)

trace.prec <- (brick('~/gdrive/Projects/Neolithic Spread/trace.01-36.22000BP.cam2.PRECC.22000BP_decavgDJF_400BCE.nc') +
  brick('~/gdrive/Projects/Neolithic Spread/trace.01-36.22000BP.cam2.PRECL.22000BP_decavgDJF_400BCE.nc')) %>% 
  rotate %>%
  crop(bbox, snap = 'out') %>%
  resample(prec) %>%
  crop(bbox) %>%
  mask(prec[[1]]) %>%
  `*`(2.628e+9)

ad200 <- mean(trace.prec[[2021:2026]])
ad850 <- mean(trace.prec[[2090:2095]])
ad1950 <- mean(trace.prec[[2199:2204]])
ad200[ad200[] < 0] <- 0
ad850[ad850[] < 0] <- 0
ad1950[ad1950[] < 0] <- 0

levelplot(brick(c(ad1950, mean(prec[[c(12, 1, 2)]]))))
brick(c((ad200 - ad1950)/ad1950, (ad850 - ad1950)/ad1950, (ad200 - ad850)/ad1950)) %>% levelplot(par.settings = RdBuTheme(), at = seq(-1,1,.2))
# so it looks like the big change is from 200 to 850

hist((ad200 - ad1950) / ad1950)

lm.prec.present <- brick('~/gdrive/Data/b40.lm850-1850.1deg.001.cam2.h0.PRECT.085001-185012.nc') %>%
  .[[12000:12012]] %>%
  rotate %>%
  crop(bbox) %>%
  resample(prec) %>%
  mask(prec[[1]])

plot(brick(c(sum(lm.prec[[c(1,2,12)]]), trace.prec[[2189]] %>% resample(prec) %>% mask(prec[[1]]))))
# and trace and lm are surprisngly close at preindustrial periods
```

```{r}
getLM <- function(x){
  brick(x) %>%
  .[[1:600]] %>%
  rotate %>%
  crop(bbox) %>%
  resample(prec) %>%
  stackApply(1:12, mean) %>%
  mask(prec[[1]])
}
getHIST <- function(x){
  brick(x) %>%
  .[[1213:1812]] %>%
  rotate %>%
  crop(bbox) %>%
  resample(prec) %>%
  stackApply(1:12, mean) %>%
  mask(prec[[1]])
}

lm.prec <- getLM('~/gdrive/Data/b40.lm850-1850.1deg.001.cam2.h0.PRECT.085001-185012.nc') %>%
  `*`(2.628e+9)
hist.prec <- getHIST('~/Downloads/b40.lm1850-2005.1deg.002.cam2.h0.PRECT.185001-200512.nc') %>%
  `*`(2.628e+9)
levelplot((lm.prec - hist.prec)/hist.prec * 100)
anom.prec <- prec + prec * ((lm.prec - hist.prec)/hist.prec)
levelplot(brick(sum(prec), sum(anom.prec)))
```

```{r}

lm.tmin <- getLM('~/gdrive/Data/b40.lm850-1850.1deg.001.cam2.h0.TREFMNAV.085001-185012.nc') %>%
  `-`(273.15)
hist.tmin <- getHIST('~/Downloads/b40.lm1850-2005.1deg.002.cam2.h0.TREFMNAV.185001-200512.nc') %>%
  `-`(273.15)
levelplot(lm.tmin - hist.tmin)
anom.tmin <- tmin + (lm.tmin - hist.tmin)
levelplot(brick(mean(anom.tmin), mean(tmin)))


lm.tmax <- getLM('~/gdrive/Data/b40.lm850-1850.1deg.001.cam2.h0.TREFMXAV.085001-185012.nc') %>%
  `-`(273.15)
hist.tmax <- getHIST('~/Downloads/b40.lm1850-2005.1deg.002.cam2.h0.TREFMXAV.185001-200512.nc') %>%
  `-`(273.15)
levelplot(lm.tmax - hist.tmax)
anom.tmax <- tmax + (lm.tmax - hist.tmax)
levelplot(brick(mean(anom.tmax), mean(tmax)))
```

```{r}
lm.pet <- hargreaves(anom.tmin %>% getValues %>% t, 
                  anom.tmax %>% getValues %>% t, 
                  Ra = srad %>% getValues %>% t, 
                  Pre = anom.prec %>% getValues %>% t, na.rm = T) %>%
  t %>%
  setValues(lm.tmin, .)

swc <- setValues(lm.pet[[1]], 100) %>% mask(lm.pet[[1]])
aet.brick <- setValues(lm.pet, 0) %>% mask(lm.pet[[1]])

for(a in 1:10){
  for(i in 1:12){
    ksoil <- swc / 350
    lm.aet <- lm.pet[[i]] * ksoil
    aet.brick[[i]] <- lm.aet
    swc.tmp <- swc + anom.prec[[i]] * (1 - .15) - lm.aet
    swc <- reclassify(swc.tmp, c(-Inf, 0, 0, 350, Inf, 350))
  }
}

alpha <- sum(aet.brick) / sum(lm.pet)

lm.temp <- (anom.tmax + anom.tmin) / 2
t_warm <- max(lm.temp)
t_cold <- min(lm.temp)

gdd5_interp <- function(x){
  if(any(is.na(x))){return(NA)} else{
    daily <- gam(x ~ s(doy, bs = 'cc', k = 12), knots = list(doy = c(1, 366))) %>%
      predict.gam(data.frame(doy = 1:365)) 
    daily[daily < 5] <- 5
    return(sum(daily - 5))
  }
}

doy <-c(15, 46, 74, 105, 135, 166, 196, 227, 258, 288, 319, 349)

beginCluster(4)
gdd5 <- clusterR(lm.temp, calc, args = list(fun = gdd5_interp), export = 'doy')
endCluster()

lm_predictors <- brick(c(t_warm, t_cold, alpha,gdd5))
names(lm_predictors) <- c('t_warm', 't_cold', 'alpha', 'gdd5')
rm(lm.prec, lm.tmin, lm.tmax, lm.pet, ksoil, lm.aet, aet.brick, swc.tmp, swc, lm.temp, t_warm, t_cold, alpha, gdd5)

plot(lm_predictors)
levelplot(brick(lm_predictors[[4]], modern_predictors[[4]]))
```

```{r}
predictions_lm <- predict(lm_predictors, veg_gam, type = 'response', index = 1:9)

uncertainty <- predictions_lm %>% 
  as.data.frame(na.rm = T, xy = T) %>%
  gather(var, val, 3:11) %>%
  group_by(x, y) %>%
  summarise(p1 = max(val), p2 = max(val[val != p1])) %>%
  mutate(ui = (p1 - p2) / p1)

# there are a handful of pixels with other types not visibleonthe mapsscale, replace with temperate forest for clarity as these pixels all are found in these areas
lc_lm <- predictions_lm %>% 
  which.max %>% 
  as.data.frame(na.rm = T, xy = T) %>% 
  mutate(class = recode_factor(as.factor(layer),
                               `6` = 'Temperate forest',
                               `9` = 'Warm-temperate forest',
                               `4` = 'Grassland and dry shrubland',
                               `3` = 'Desert (vegetated)',
                               `1` = 'Desert (bare)', .default = 'Temperate forest'  
                           )) %>%
  left_join(uncertainty)


lc_colors <- c('#016400', '#018200', '#97bf47','#dcce00',  '#fffbc3')

ggplot(lc_lm, aes(x, y)) + 
  geom_tile(aes(alpha = ui, fill = class)) + 
  scale_fill_manual(values = lc_colors) + 
  theme_void() + 
  coord_fixed()
ggplot(lc_lm, aes(x, y)) + 
  geom_tile(aes(fill = class)) + 
  scale_fill_manual(values = lc_colors) + 
  theme_void() + 
  coord_fixed()

ggplot(lc_mod, aes(x, y)) + 
  geom_tile(aes(fill = class)) + 
  scale_fill_manual(values = lc_colors) + 
  theme_void() + 
  coord_fixed()
```






