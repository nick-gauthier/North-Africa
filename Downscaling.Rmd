---
title: "Downscaling"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Setup
Load packages necessary for analysis.
```{r}
library(raster)
library(rasterVis)
library(tidyverse)
library(mgcv)
library(fields)
library(parallel)
library(gdistance)
```


## Input Data
### Topography
First define a bounding box for the study area.
```{r}
bbox <- extent(-10, 20, 28, 38)
```

Import the 1km SRTM DEM and crop to study area.
```{r}
elev1k <- raster('~/gdrive/Data/SRTM_1km.tif') %>% crop(bbox)
```

Generate a mask to get rid of Sicily and Spain.
```{r}
na.mask <- elev1k %>% aggregate(fact = 5) %>% clump %>% mask(., ., maskvalue = 7, inverse = T) %>% aggregate(fact = 2)
```

Resample the elevation map to 5', use the 1km and 5' elevation data to generate a series of topographic derivatives.
```{r}
elev <- resample(elev1k, na.mask) %>% mask(na.mask)

rough <- terrain(elev, opt = 'roughness')

dco <- elev %>%
  reclassify(c(-Inf, Inf, NA, NA, NA, 1)) %>% # reverse NA and non-NA cells
  distance(doEdge = T) %>% # calculate the distances
  mask(elev) %>% # mask out ocean cells  
  `/`(1000) # convert to km

plot(brick(elev, rough, dco))

#the following two maps will be used for wind calculations, so reproject to LCC to preserve angles.
aspect <- elev  %>% terrain(opt='aspect', unit = 'degrees') %>% projectRaster(crs = "+proj=lcc")

slope <- elev1k %>%
  terrain(opt = 'slope', unit = 'degrees') %>% 
  aggregate(fact = 10, fun = median) %>% 
  mask(na.mask) %>% 
  projectRaster(crs = "+proj=lcc") 

plot(brick(aspect, slope))
```

### Observed Climate
Import observed CHELSA data.
```{r}
prec.obs <- brick('Data/CHELSA/prec.nc') %>% crop(bbox) %>% mask(na.mask)
levelplot(prec.obs)

temp.obs <- brick('Data/CHELSA/temp.nc') %>% crop(bbox) %>% mask(na.mask)
levelplot(temp.obs)
```

### GCM Variables
Create a function to interpolate the coarse resolution GCM data using splines.
```{r warnings = F}
tpsInterp <- function(rast.brick){
  target <- resample(rast.brick[[1]], prec.obs[[1]])
  lapply(1:nlayers(rast.brick), function(rast.index){
    rast.map <- rast.brick[[rast.index]]
    xy <- data.frame(xyFromCell(rast.map, 1:ncell(rast.map)))
    v <- getValues(rast.map)
    tps <- Tps(xy, v)
    interpolate(target, tps)
  }) %>% unlist %>% brick
}
```

Now import and process GCM data from the CCSM4 Last Millennium extension.
```{r}
getGCM <- function(x, level = 1){
  brick(x, level = level) %>% 
    .[[1213:1872]] %>%
    rotate %>%
    crop(bbox) %>%
    tpsInterp %>%
    stackApply(1:12, mean) %>%
    crop(bbox) %>%
    mask(na.mask)
}
```

```{r warnings = F, cache = T}
# Temperature
trefht <- getGCM('~/Downloads/b40.lm1850-2005.1deg.002.cam2.h0.TREFHT.185001-200512.nc') - 273.15
levelplot(trefht)
```

```{r warnings = F, cache = T}
# Precipitation
precl <- getGCM('~/Downloads/b40.lm1850-2005.1deg.002.cam2.h0.PRECL.185001-200512.nc') * 2629743830
precc <- getGCM('~/Downloads/b40.lm1850-2005.1deg.002.cam2.h0.PRECC.185001-200512.nc') * 2629743830

#spline interpolation will result in some values very slightly less than 0, unrealistic for precipitation
precl[precl[] < 0] <- 0 
precc[precc[] < 0] <- 0

levelplot(precl)
levelplot(precc)
```

```{r warnings = F, cache = T}
# Wind at ~850 level
u <- getGCM('~/Downloads/b40.lm1850-2005.1deg.002.cam2.h0.U.185001-200512.nc', level = 23) %>% projectRaster(crs = "+proj=lcc")
v <- getGCM('~/Downloads/b40.lm1850-2005.1deg.002.cam2.h0.V.185001-200512.nc', level = 23) %>% projectRaster(crs = "+proj=lcc")

streamplot(stack(u[[1]], v[[1]]), isField = 'dXY')
streamplot(stack(u[[7]], v[[7]]), isField = 'dXY')
```

Calculate hybrid wind/topographic derivatives.

```{r}
dir <- (270 - atan2(v, u) * (180 / pi)) %% 360
levelplot(dir)

vel <- sqrt(u ^ 2 + v^ 2)
levelplot(vel)

delta <- abs(dir - aspect) # distance between wind angle and slope orientation
values(delta) <- ifelse(values(delta) > 180, 360 - values(delta), values(delta))
levelplot(delta)

lift.angle <- (sin(slope * 2 * pi / 180) * cos(delta * pi / 180)) %>% projectRaster(elev)
levelplot(lift.angle, par.settings = RdBuTheme())

oro <- (sin(slope * 2 * pi / 180) * cos(delta * pi / 180) * vel * .5) %>% projectRaster(elev)
levelplot(oro, par.settings = RdBuTheme())
```

Air parcel paths.
```{r}
dir.discrete <- dir %>% 
  reclassify(c(0, 45, 128, 45, 90, 1, 90, 135, 2, 135, 180, 4, 180, 225, 8, 225, 270, 16, 270, 315, 32, 315, 360, 64))

target.cells <- Which(elev, cells = T)
aco <- prec.obs
for(i in 1:12){
  aco[[i]][target.cells] <- mclapply(target.cells, function(x){
    dir.discrete[[i]] %>%
    flowPath(x) %>%
    xyFromCell(elev, .) %>%
    length
}) %>% unlist
}

```

Auxiliary variables.
```{r}
month <- prec.obs %>% setValues(c(as.factor(rep(1:12, each = ncell(elev)))))
lat <- elev %>%
     coordinates %>%
     .[,2] %>% 
     setValues(elev, .)

lon <- elev %>%
     coordinates %>%
     .[,1] %>% 
     setValues(elev, .)
```

### Collect the data
```{r}
aco <- oro
vars <- sapply(1:12, function(x){
  brick(temp.obs[[x]], prec.obs[[x]], trefht[[x]], precc[[x]], precl[[x]], dir[[x]] %>% projectRaster(elev), 
        vel[[x]] %>% projectRaster(elev), delta[[x]] %>% projectRaster(elev), oro[[x]], lift.angle[[x]], aco[[x]], dco, rough, elev, slope%>% projectRaster(elev), aspect%>% projectRaster(elev), lat, lon, month[[x]]) %>%
    setNames(c('temp.obs', 'prec.obs', 'trefht', 'precc', 'precl', 'dir', 'vel', 'delta', 'oro', 'lift.angle', 'aco', 'dco', 'rough', 'elev', 'slope', 'aspect', 'lat', 'lon', 'month'))
})

dat <- lapply(vars, as.data.frame, na.rm = T) %>% 
  do.call(rbind, .)
```

## Temperature model
Temperature is well constrained in the GCM, so the model doesn't need to be too complicated. A model using elevation and GCM temperature seems reasonable.
```{r}
ggplot(dat, aes(trefht, temp.obs)) +
  geom_point(aes(color = as.factor(month)), alpha = .1, size = .3) +
  geom_smooth() +
  theme_minimal()
```
From the above plot it looks like the relationship is roughly linear and constant throughout the year, with deviations due to elevation.
Make sure there is a constant relationship with elevation.
```{r}
ggplot(dat, aes(elev, temp.obs)) +
  geom_point(aes(color = as.factor(month)), alpha = .1, size = .3) +
  geom_smooth() +
  theme_minimal()
```
The elevation slope appears constant, but the intercept depends on the season.
First fit a model with just temperature from the GCM, and then one with temperature and elevation
```{r}
temp.mod1 <- bam(temp.obs ~ s(trefht, bs = 'cr', k = 10), data = dat)
summary(temp.mod1)
plot(temp.mod1)
```
Pretty good, 73% deviance explained and AIC of 1875984.

Elevation seems to explain most of the variance in the residuals.
```{r}
ggplot(dat, aes(elev, temp.mod1$residuals))  +
  geom_point(aes(color = as.factor(month)), alpha = .1, size = .3) +
  geom_smooth() +
  theme_minimal()
```
Now fit two elevation models, one with a constant elevation lapse rate and one with a seasonally varying one.
```{r}
temp.mod2 <- bam(temp.obs ~ s(trefht, bs = 'cr', k = 10) +
                   s(elev, bs = 'cr', k = 10), data = dat)
summary(temp.mod2)
plot(temp.mod2)
temp.mod2$aic
```
Better aic (1836350), but not by much. Try seasonal variability.
```{r}
temp.mod3 <- bam(temp.obs ~ s(trefht, bs = 'cr', k = 10) +
                   te(elev, month, bs = c('cr', 'cc'), k = c(10, 12)), data = dat, knots = list(month = c(0.5, seq(1, 12, length = 10), 12.5)))
summary(temp.mod3)
plot(temp.mod3, pers = T)
```
Thats much better, 94.7% deviance explained and 1347038 aic. The tensor product smooth between month and elevation leads to increasedlapse rates in the summer.

Now let's plot the predictions of the three models, and compare them to observations.

```{r}
temp.preds <- lapply(vars, predict, temp.mod3) %>% brick

levelplot(temp.obs - temp.preds, par.settings = RdBuTheme(), at = seq(-11, 11, 1))
``` 

Let's add in distance from the ocean.
```{r}
temp.mod4 <- bam(temp.obs ~ s(trefht, bs = 'cr', k = 10) +
                   s(dco, bs ='cr', k = 10) +
                   te(elev, month, bs = c('cr', 'cc'), k = c(10, 5)), data = dat, select = T, knots = list(month = c(0.5, seq(1, 12, length = 3), 12.5)))
summary(temp.mod4)
temp.mod4$aic
plot(temp.mod4, pers = T)
```
Look at the residuals again
```{r}
temp.preds <- lapply(vars, predict, temp.mod4) %>% brick
levelplot(temp.obs - temp.preds, par.settings = RdBuTheme(), at = seq(-10, 10, 1))
``` 

Elevation looks fine.
```{r}
ggplot(dat, aes(elev, temp.mod4$residuals))  +
  geom_point(aes(color = as.factor(month)), alpha = .1, size = .3) +
  geom_smooth() +
  theme_minimal()
```
so does temperature.
```{r}
ggplot(dat, aes(trefht, temp.mod4$residuals))  +
  geom_point(aes(color = as.factor(month)), alpha = .1, size = .3) +
  geom_smooth() +
  theme_minimal()
```
There does seem to be some seasonal signal in the residuals against dco, perhaps seasonally varying dco as well?
```{r}
ggplot(dat, aes(dco, temp.mod4$residuals))  +
  geom_point(aes(color = as.factor(month)), alpha = .1, size = .3) +
  geom_smooth() +
  theme_minimal()
```
```{r}
temp.mod5 <- bam(temp.obs ~ s(trefht, bs = 'cr', k = 10) +
                   te(dco, month, bs = c('cr', 'cc'), k = c(10, 5)) +
                   te(elev, month, bs = c('cr', 'cc'), k = c(10, 5)), data = dat, select = T, knots = list(month = c(0.5, seq(1, 12, length = 3), 12.5)))
summary(temp.mod5)
temp.mod5$aic
plot(temp.mod5, pers = T)
```

```{r}
ggplot(dat, aes(slope, temp.mod5$residuals))  +
  geom_point(aes(color = as.factor(month)), alpha = .1, size = .3) +
  geom_smooth() +
  theme_minimal()
```
Try incorporating slope and aspect.
```{r}
temp.mod6 <- bam(temp.obs ~ s(trefht, bs = 'cr', k = 10) +
                   s(slope, bs = 'cr', k = 10) +
                   s(aspect, bs = 'cc', k = 10) +
                   ti(slope, aspect, bs = c('cr','cc')) +
                   te(dco, month, bs = c('cr', 'cc'), k = c(10, 5)) +
                   te(elev, month, bs = c('cr', 'cc'), k = c(10, 5)), data = dat, select = T, knots = list(month = c(0.5, seq(1, 12, length = 3), 12.5)))
temp.mod7 <- bam(temp.obs ~ s(trefht, bs = 'cr', k = 10) +
                   te(slope, aspect, bs = c('cr','cc')) +
                   te(dco, month, bs = c('cr', 'cc'), k = c(10, 5)) +
                   te(elev, month, bs = c('cr', 'cc'), k = c(10, 5)), data = dat, select = T, knots = list(month = c(0.5, seq(1, 12, length = 3), 12.5)))
temp.mod8 <- bam(temp.obs ~ s(trefht, bs = 'cr', k = 10) +
                   s(slope, bs = 'cr', k = 10) +
                   ti(slope, aspect, bs = c('cr','cc')) +
                   te(dco, month, bs = c('cr', 'cc'), k = c(10, 5)) +
                   te(elev, month, bs = c('cr', 'cc'), k = c(10, 5)), data = dat, select = T, knots = list(month = c(0.5, seq(1, 12, length = 3), 12.5)))

temp.mod6$aic;temp.mod7$aic;temp.mod8$aic
plot(temp.mod7, pers = T)
``` 
Model7, with a tensor smooth of slope andaspect (rather than more complex interactions) seems like the best bet (low aic but still interpretable).

```{r}
temp.preds <- lapply(vars, predict, temp.mod6) %>% brick
levelplot(temp.obs - temp.preds, par.settings = RdBuTheme(), at = seq(-7, 7, .7))
levelplot(brick(temp.preds[[1]], temp.obs[[1]], temp.preds[[7]], temp.obs[[7]]))
```

Its official, let's use temp.mod6 as the official model.
```{r}
temp.mod <- temp.mod6
saveRDS(temp.mod, 'temp_mod')
```

little experiment with anomaly-based regression.

```{r}
levelplot(temp.obs - mean(temp.obs))
levelplot(mean(temp.obs))

plot(mean(temp.obs), elev)
plot(mean(temp.obs), dco)
plot(mean(temp.obs), projectRaster(slope, elev))
plot(mean(temp.obs), mean(trefht))
levelplot(brick(c(temp.obs - mean(temp.obs), trefht - mean(trefht))))
```

```{r}
prec.mod <- bam(prec.obs ~ s(precc, bs = 'cr') +
                  s(precl, bs = 'cr'),
                data = prec.dat, family = Gamma(link = 'log'))
prec.mod1 <- bam(prec.obs ~ s(precc, bs = 'cr', k = 10) +
                  s(precl, bs = 'cr', k = 10),
                data = prec.dat, family = Gamma(link = 'log'))
prec.mod2 <- bam(prec.obs ~ s(log(precc), bs = 'cr', k = 10) +
                  s(log(precl), bs = 'cr', k = 10),
                data = prec.dat, family = Gamma(link = 'log'))
```
Varying coefficient with elevation seasonally
```{r}
ggplot(prec.dat, aes(elev, prec.obs)) +
  geom_point(aes(color = as.factor(month)), alpha = .1, size = .3) +
  geom_smooth() +
  facet_wrap(~as.factor(month)) +
  theme_minimal()
```


```{r}
ggplot(prec.dat, aes(rough*(1/dco), prec.obs)) +
  geom_point(aes(color = as.factor(month)), alpha = .1, size = .3) +
  geom_smooth() +
  facet_wrap(~as.factor(month)) +
  theme_minimal()
```


direction and season interaction
```{r}
ggplot(prec.dat, aes(dir, prec.obs)) +
  geom_point(aes(color = as.factor(month)), alpha = .1, size = .3) +
  geom_smooth() +
  facet_wrap(~as.factor(month)) +
  theme_minimal()
```

```{r}
ggplot(prec.dat, aes(dco, prec.obs)) +
  geom_point(aes(color = as.factor(month)), alpha = .1, size = .3) +
  geom_smooth() +
  facet_wrap(~as.factor(month)) +
  theme_minimal()
```

interaction doesn't vary seasonally
```{r}
ggplot(prec.dat, aes(dco*dir, prec.obs)) +
  geom_point(aes(color = as.factor(month)), alpha = .1, size = .3) +
  geom_smooth() +
  facet_wrap(~as.factor(month)) +
  theme_minimal()
```

```{r}
ggplot(prec.dat, aes(oro, prec.obs)) +
  geom_point(aes(color = as.factor(month)), alpha = .1, size = .3) +
  geom_smooth() +
  facet_wrap(~as.factor(month)) +
  theme_minimal()
```

```{r}
ggplot(prec.dat, aes(oro*dco, prec.obs)) +
  geom_point(aes(color = as.factor(month)), alpha = .1, size = .3) +
  geom_smooth() +
  facet_wrap(~as.factor(month)) +
  theme_minimal()
```
```{r}
ggplot(prec.dat, aes(delta, prec.obs)) +
  geom_point(aes(color = as.factor(month)), alpha = .1, size = .3) +
  geom_smooth() +
  facet_wrap(~as.factor(month)) +
  theme_minimal()
```
```{r}
ggplot(prec.dat, aes(vel, prec.obs)) +
  geom_point(aes(color = as.factor(month)), alpha = .1, size = .3) +
  geom_smooth() +
  facet_wrap(~as.factor(month)) +
  theme_minimal()
```
```{r}
ggplot(prec.dat, aes(oro2, prec.obs)) +
  geom_point(aes(color = as.factor(month)), alpha = .1, size = .3) +
  geom_smooth() +
  facet_wrap(~as.factor(month)) +
  theme_minimal()
```

```{r}
ggplot(prec.dat, aes(lat, prec.obs)) +
  geom_point(aes(color = elev), alpha = .1, size = .3) +
  geom_smooth() +
  facet_wrap(~as.factor(month)) +
  theme_minimal()
```
```{r}
ggplot(prec.dat, aes(lon, prec.obs)) +
  geom_point(aes(color = as.factor(month)), alpha = .1, size = .3) +
  geom_smooth() +
  facet_wrap(~as.factor(month)) +
  theme_minimal()
```
```{r}
ggplot(prec.dat, aes(precl, prec.obs)) +
  geom_point(aes(color = as.factor(month)), alpha = .1, size = .3) +
  geom_smooth() +
  facet_wrap(~as.factor(month)) +
  theme_minimal()
```
```{r}
ggplot(prec.dat, aes(precc, prec.obs)) +
  geom_point(aes(color = as.factor(month)), alpha = .1, size = .3) +
  geom_smooth() +
  facet_wrap(~as.factor(month)) +
  theme_minimal()
```
```{r}
ggplot(prec.dat, aes(as.factor(month))) +
  geom_bar(aes(weight = prec.obs, fill = ..count..)) +
  theme_minimal()
```
```{r}
prec.dat %>% 
  group_by(month) %>%
  transmute(prc = mean(prec.obs)) %>%
  ggplot(aes(month, prc))+
  geom_line()
```

```{r}
prec.mod3 <- gam(prec.obs ~ s(precc, bs = 'cr') +
                  s(precl, bs = 'cr') +
                   s(elev, bs = 'cr'),
                data = prec.dat, family = Gamma(link = 'log'), method = 'REML')
prec.mod4 <- gam(prec.obs ~ s(precc, bs = 'cr') +
                  s(precl, bs = 'cr') +
                   s(elev, bs = 'cr') +
                   s(oro, bs = 'cr'),
                data = prec.dat, family = Gamma(link = 'log'), method = 'REML')
prec.mod5 <- bam(prec.obs ~ s(precc, bs = 'cr') +
                  s(precl, bs = 'cr') +
                   s(elev, bs = 'cr') +
                   s(oro, bs = 'cr') +
                   ti(precl, oro),
                data = prec.dat, family = Gamma(link = 'log'), select = T, method = 'REML')
prec.mod6 <- bam(prec.obs ~ s(precc, bs = 'cr') +
                  s(precl, bs = 'cr') +
                   s(elev, bs = 'cr') +
                   s(oro, k = 20, bs = 'cr') +
                   s(dco, bs = 'cr'),
                data = prec.dat, family = Gamma(link = 'log'), select = T, method = 'REML')
prec.mod7 <- bam(prec.obs ~ s(precc, bs = 'cr') +
                  s(precl, bs = 'cr') +
                   s(elev, bs = 'cr') +
                   s(oro, bs = 'cr') +
                   ti(precl, dco, bs = 'cr'),
                data = prec.dat, family = Gamma(link = 'log'), select = T, method = 'REML')
prec.mod8 <- bam(prec.obs ~ s(precc, bs = 'cr') +
                  s(precl, bs = 'cr') +
                  s(elev, bs = 'cr') +
                  s(aco, bs = 'cr'),
                data = prec.dat, family = Gamma(link = 'log'), select = T, method = 'REML')
prec.mod9 <- bam(prec.obs ~ s(precc, bs = 'cr') +
                  s(precl, bs = 'cr') +
                  s(elev, bs = 'cr') +
                  te(aco, oro, bs = 'cr'),
                data = prec.dat, family = Gamma(link = 'log'), select = T, method = 'REML')
prec.mod10 <- bam(prec.obs ~ s(precc, bs = 'cr') +
                  s(precl, bs = 'cr') +
                  s(elev, bs = 'cr') +
                  s(aco, bs = 'cr') +
                    s(dco, bs = 'cr') +
                    s(oro, k = 20, bs = 'cr'),
                data = prec.dat, family = Gamma(link = 'log'), select = T, method = 'REML')
prec.mod11 <- bam(prec.obs ~ s(precc, bs = 'cr') +
                  s(precl, bs = 'cr') +
                  s(elev, bs = 'cr') +
                  s(aco, bs = 'cr') +
                  s(oro, k = 20, bs = 'cr'),
                data = prec.dat, family = Gamma(link = 'log'), select = T, method = 'REML')
prec.mod12 <- bam(prec.obs ~ s(precc, bs = 'cr') +
                  s(precl, bs = 'cr') +
                  s(elev, bs = 'cr') +
                    s(dco, bs = 'cr') +
                    te(oro, aco),
                data = prec.dat, family = Gamma(link = 'log'), select = T, method = 'REML')
prec.mod13 <- bam(prec.obs ~ s(precc, bs = 'cr') +
                  s(precl, bs = 'cr') +
                  s(elev, bs = 'cr') +
                  s(aco, bs = 'cr') +
                    s(dco, bs = 'cr') +
                    te(oro, precl),
                data = prec.dat, family = Gamma(link = 'log'), select = T, method = 'REML')
prec.mod14 <- bam(prec.obs ~ s(precc, bs = 'cr') +
                  s(precl, bs = 'cr') +
                  s(elev, bs = 'cr') +
                  s(aco, bs = 'cr') +
                    s(dco, bs = 'cr') +
                    s(oro, k = 20, bs = 'cr') +
                    ti(precl, aco),
                data = prec.dat, family = Gamma(link = 'log'), select = T, method = 'REML')
prec.mod15 <- bam(prec.obs ~ s(precc, bs = 'cr') +
                  s(precl, bs = 'cr') +
                  s(elev, bs = 'cr') +
                  s(aco, bs = 'cr') +
                    te(oro, precl),
                data = prec.dat, family = Gamma(link = 'log'), select = T, method = 'REML')
prec.mod16 <- bam(prec.obs ~ s(precl, bs = 'cr') +
                    s(precc, bs = 'cr') +
                    s(elev, bs = 'cr') +
                    te(dco, dir, bs = c('cr', 'cc')),
                  data = prec.dat, family = Gamma(link = 'log'))
prec.mod17 <- bam(prec.obs ~ s(precl, bs = 'cr') +
                    s(precc, bs = 'cr') +
                    s(elev, bs = 'cr') +
                    te(dco, oro, k = c(5, 30)),
                  data = prec.dat, family = Gamma(link = 'log'))

prec.mod19 <- bam(prec.obs ~ s(precc, bs = 'cr',k = 30) +
                  s(precl, bs = 'cr', k = 10) +
                   s(elev, bs = 'cr') +
                   te(dco, dir, bs = c('cr', 'cc')),
                data = prec.dat, family = Gamma(link = 'log'), method = 'REML')

prec.mod20 <- bam(prec.obs ~ s(precc, bs = 'cr',k = 30) +
                  s(precl, bs = 'cr', k = 10) +
                   s(elev, bs = 'cr') +
                    s(oro, bs = 'cr', k = 30) +
                   te(dco, dir, bs = c('cr', 'cc')),
                data = prec.dat, family = Gamma(link = 'log'), method = 'REML')

prec.mod21 <- bam(prec.obs ~ te(precc, month, bs = c('cr', 'cc')) +
                  s(precl, bs = 'cr', k = 10) +
                   s(elev, bs = 'cr'),
                data = prec.dat, family = Gamma(link = 'log'), method = 'REML')

prec.mod22 <- bam(prec.obs ~ te(precc, month, bs = c('cr', 'cc'), k = c(10, 12)) +
                  s(precl, bs = 'cr', k = 10) +
                   s(elev, bs = 'cr') +
                  te(dco, dir, bs = c('cr', 'cc')),
                data = prec.dat, family = Gamma(link = 'log'), method = 'REML')
prec.mod23 <- bam(prec.obs ~ te(precc, month, bs = c('cr', 'cc'), k = c(10, 12)) +
                  s(precl, bs = 'cr', k = 10) +
                   s(elev, bs = 'cr') +
                    s(oro, bs = 'cr', k = 30) +
                  te(dco, dir, bs = c('cr', 'cc')),
                data = prec.dat, family = Gamma(link = 'log'), method = 'REML')


knots <- list(month = c(0.5, seq(1, 12, length = 10), 12.5))

prec.mod24 <- bam(prec.obs ~ s(month, bs = 'cc', k = 12) +
                    s(precc, bs = 'cr', k = 10) +
                    s(precl, bs = 'cr', k = 10) +
                    ti(precc, month, bs = c('cr', 'cc'), k = c(10, 12)) +
                   s(elev, bs = 'cr'),
                data = prec.dat, family = Gamma(link = 'log'), knots = knots, method = 'REML', select = T)

prec.mod25 <- bam(prec.obs ~ 
                    s(precl, bs = 'cr', k = 10) +
                    te(precc, month, bs = c('cr', 'cc'), k = c(10, 12)) +
                   s(elev, bs = 'cr'),
                data = prec.dat, family = Gamma(link = 'log'), knots = knots, method = 'REML', select = T)

prec.mod26 <- bam(prec.obs ~ 
                    s(precl, bs = 'cr', k = 10) +
                    te(precc, month, bs = c('cr', 'cc'), k = c(10, 12)) +
                   s(elev, bs = 'cr') +
                    te(rough, dco, bs = 'cr'),
                data = prec.dat, family = Gamma(link = 'log'), knots = knots, method = 'REML', select = T)

prec.mod27 <- bam(prec.obs ~ s(precl, bs = 'cr', k = 10) +
                    te(precc, month, bs = c('cr', 'cc'), k = c(10, 12)) +
                   s(elev, bs = 'cr') +
                    s(oro, bs = 'cr', k = 30) +
                    te(rough, dco, bs = 'cr'),
                data = prec.dat, family = Gamma(link = 'log'), knots = knots, method = 'REML', select = T)

prec.mod28 <- bam(prec.obs ~ s(precl, bs = 'cr', k = 10) +
                    te(precc, month, bs = c('cr', 'cc'), k = c(10, 12)) +
                   s(elev, bs = 'cr') +
                    s(oro, bs = 'cr', k = 30) +
                    s(vel, bs = 'cr', k = 10) +
                    te(rough, dco, bs = 'cr'),
                data = prec.dat, family = Gamma(link = 'log'), knots = knots, method = 'REML', select = T)
prec.mod29 <- bam(prec.obs ~ s(precl, bs = 'cr', k = 10) +
                    te(precc, month, bs = c('cr', 'cc'), k = c(10, 12)) +
                   s(elev, bs = 'cr') +
                    s(oro, bs = 'cr', k = 30) +
                    te(vel, delta) +
                    te(rough, dco, bs = 'cr'),
                data = prec.dat, family = Gamma(link = 'log'), knots = knots, method = 'REML', select = T)

prec.mod30 <- bam(prec.obs ~ 
                    s(precl, bs = 'cr', k = 10) +
                    s(precc, as.factor(month), bs = 'fs') +
                   s(elev, bs = 'cr'),
                data = prec.dat, family = Gamma(link = 'log'), knots = knots, method = 'REML', select = T)

plot(prec.mod25, pers = T)
summary(prec.mod24)

prec.mod22$residuals^2 %>% mean %>% sqrt

prec.mod$aic;prec.mod1$aic;prec.mod2$aic;prec.mod3$aic;prec.mod4$aic;prec.mod5$aic;prec.mod6$aic;prec.mod7$aic;prec.mod8$aic;prec.mod9$aic;prec.mod10$aic;prec.mod11$aic;prec.mod12$aic;prec.mod13$aic;prec.mod14$aic;prec.mod15$aic;prec.mod16$aic;prec.mod17$aic;prec.mod19$aic;prec.mod20$aic;prec.mod21$aic;prec.mod22$aic;prec.mod23$aic;prec.mod24$aic;prec.mod25$aic;prec.mod26$aic;prec.mod27$aic;prec.mod28$aic;prec.mod29$aic;prec.mod30$aic



preds <- lapply(vars, predict, prec.mod27, type = 'response') %>% brick
levelplot(prec.obs - preds, at = seq(-100, 100, 20), par.settings = BuRdTheme())
levelplot((sum(prec.obs) - sum(preds))/sum(prec.obs), at = seq(-100, 100, 10), par.settings = BuRdTheme())
levelplot((sum(prec.obs) - sum(preds)), at = seq(-200, 200, 20), par.settings = BuRdTheme())

levelplot(brick(sum(prec.obs), sum(preds)))
levelplot(preds)
levelplot(precc + precl)
levelplot(brick(precc[[7]], prec.obs[[7]]))
```

Use geosphere to calculate air paths
```{r}

```

```{r}

```

