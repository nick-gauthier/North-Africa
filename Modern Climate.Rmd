---
title: "Modern Climate"
author: "Nick Gauthier"
date: "6/7/2017"
output: 
  html_document: 
    highlight: pygments
    keep_md: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Present Day Climate in North Africa
```{r}
library(raster)
library(tidyverse)
library(ClimClass)
library(parallel)
```


```{r}
bbox <- extent(-10, 20, 30, 38)

prec <- getData('worldclim', var = 'prec', res = 2.5) %>%
  crop(bbox)

na.clump <- clump(prec[[1]])
prec <- mask(prec, na.clump, maskvalue = 7, inverse = T)

tmin <- getData('worldclim', var = 'tmin', res = 2.5) %>%
  crop(bbox) %>%
  mask(na.clump, maskvalue = 7, inverse = T) %>%
  `/`(10)

tmax <- getData('worldclim', var = 'tmax', res = 2.5) %>%
  crop(bbox) %>%
  mask(na.clump, maskvalue = 7, inverse = T) %>%
  `/`(10)
```

```{r}
koeppen_map <- function(x){
  ifelse(is.na(prec[x][1]), 
         return(NA),
      return(data_frame(month = 1:12,
           P = c(prec[x]),
           Tx = c(tmax[x]),
           Tn = c(tmin[x])) %>%
    mutate(Tm = (Tx + Tn) / 2) %>%
    koeppen_geiger(clim.resume_verbose = F) %>%
    .$class %>%
      as.character))
}


clim_class <- mclapply(1:ncell(prec), koeppen_map, mc.cores = detectCores()) %>% 
  unlist %>%
  as.factor %>%
  setValues(prec[[1]], .)
```


```{r}
clim_class %>% 
  as.data.frame(xy = T, na.rm = T) %>%
  mutate(class = recode_factor(prec1_VALUE, BSh = 'Hot semi-arid',
  BSk = 'Cold semi-arid',
  BWh = 'Hot desert',
  BWk = 'Cold desrt',
  Csa = 'Hot-summer Mediterranean',
  Csb = 'Warm-summer Mediterranean',
  Dsb = 'Warm, dry-summer continental',
  Dsc = 'Dry-summer subarctic')) %>%
  ggplot(aes(x, y, fill = class)) +
  geom_raster() +
  labs(title = 'Present day climate of North Africa', subtitle = 'Based on WorldClim data') +
  scale_fill_discrete(name = 'KÃ¶ppen-Geiger classification') +
  theme_void() +
  coord_quickmap()
```

# Land Use
```{r}

recode_factor()

LC2012 <- raster('LC_5min_global_2012.tif') %>%
  crop(bbox)  %>%
  as.data.frame(xy = T) %>%
  mutate(class = recode_factor(LC_5min_global_2012,
                               `0` = 'Water',
                               `1` = 'Evergreen Needleleaf forest',
                               `2` = 'Evergreen Broadleaf forest',
                               `3` = 'Deciduous Needleleaf forest',
                               `4` = 'Deciduous Broadleaf forest',
                               `5` = 'Mixed forest',
                               `6` = 'Closed shrublands',
                               `7` = 'Open shrublands',
                               `8` = 'Woody savannas',
                               `9` = 'Savannas',
                               `10` = 'Grasslands',
                               `11` = 'Permanent wetlands',
                               `12` = 'Croplands',
                               `13` = 'Urban and built-up',
                               `14` = 'Cropland/Natural vegetation mosaic',
                               `15` = 'Snow and ice',
                               `16` = 'Barren or sparsely vegetated'))

ggplot(LC2012, aes(x, y, fill = class)) +
  geom_raster() +
  theme_void() +
  coord_quickmap()

LC2001 <- raster('LC_5min_global_2001.tif') %>%
  crop(bbox)


plot(LC2012)
plot(LC2001)
LC2012
```
```{r}
avhrr <- raster('AVHRR_1km_LANDCOVER_1981_1994.GLOBAL.tif') %>%
  crop(bbox)

plot(avhrr)
```

