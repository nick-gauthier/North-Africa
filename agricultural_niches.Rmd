---
title: "Agricultural Niches"
output: html_notebook
---

```{r}
library(raster)
library(rasterVis)
library(tidyverse)
library(mgcv)
library(pbapply)
```


```{r}
wheat.area <- raster('~/Downloads/Ramankutty Crops/wheat_HarvAreaYield2000_Geotiff/wheat_HarvAreaYield2000_Geotiff/wheat_HarvestedAreaFraction.tif')
```

```{r}
levelplot(wheat.area)
```

```{r}
temp <- brick('Data/CHELSA/temp.nc')
```

```{r}
gdd_interp <- function(x){
    if(any(is.na(x))){return(NA)} else{
      dat <- data.frame(doy =  c(15, 46, 74, 105, 135, 166, 196, 227, 258, 288, 319, 349),
                        temp = temp[7090400])
      daily <- gam(temp ~ s(doy, bs = 'cc', k = 12), knots = list(doy = c(1, 366)), data = dat) %>%
        predict.gam(data.frame(doy = 1:365)) 
      daily[daily < 5] <- 5
      daily[daily > 30] <- 30
      return(sum(daily - 5))
    }
}


gdd <- temp %>%
  getValues %>%
  pbapply(1, gdd_interp) 

#%>% 
  c %>%
  setValues(wheat.area, .)
unique(gdd)
plot(gdd)
```

