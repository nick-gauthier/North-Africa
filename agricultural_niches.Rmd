---
title: "Agricultural Niches"
output: html_notebook
---

```{r}
library(raster)
library(rasterVis)
library(tidyverse)
library(mgcv)
```


```{r}
wheat.area <- raster('~/Downloads/Ramankutty Crops/wheat_HarvAreaYield2000_Geotiff/wheat_HarvAreaYield2000_Geotiff/wheat_HarvestedAreaFraction.tif')
```

```{r}
levelplot(wheat.area)
```

```{r}
temp <- brick('Data/CHELSA/temp.nc')
```

```{r}
gdd_interp <- function(x){
    if(any(is.na(x))){return(NA)} else{
    daily <- gam(x ~ s(doy, bs = 'cc', k = 12), knots = list(doy = c(1, 366))) %>%
        predict.gam(data.frame(doy = 1:365)) 
    daily[daily < 5] <- 5
    daily[daily > 30] <- 30
    return(sum(daily - 5))
    }
}

doy <-c(15, 46, 74, 105, 135, 166, 196, 227, 258, 288, 319, 349)

beginCluster(4)
test <- clusterR(temp, calc, args = list(fun = gdd_interp), export = 'doy')
endCluster()

writeRaster(gdd, 'gdd_global.tif')
```

```{r}
plot(gdd, wheat.area, maxpixels = 1000000)
```


```{r}
alpha <- raster('~/Downloads/CGIAR PET/ALPHA/alpha/w001001.adf') %>% resample(gdd)
plot(alpha)
plot(alpha, wheat.area, maxpixels = 1000000)

```

```{r}
ph.sg <- raster('~/Downloads/SoilGrids250/PHIHOX_M_sl4_250m_ll.tif') %>%
  resample(gdd) %>%
  `*`(.1)
c.sg <- raster('~/Downloads/SoilGrids250/OCSTHA_M_30cm_250m_ll.tif') %>%
  resample(gdd) %>%
  `*`(.1) %>%
plot(ph.sg)

```

