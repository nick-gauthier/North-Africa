---
title: "Surface Data"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Creation of surface datasets for Roman LULCC simulations

## Setup
Import necessary packages

```{r}
library(tidyverse)
```

```{r}
#devtools::install_github("bergant/nlexperiment")
library(nlexperiment)
nl_netlogo_path('/home/nick/Netlogo/NetLogo 6.0.2/app/') 
```


```{r}
experiment <- nl_experiment( 
  model_file = '/home/nick/gdrive/Projects/North-Africa/cities-nw-calib.nlogo',
  while_condition = 'ticks < sim-length',
  param_values = list(
    sim_length = seq(100, 500, 100),
    coastal_flows = seq(0, 1, 0.1),
    alpha = seq(0.85, 1.15, .05),
    beta = seq(20, 60, 5)
  ),
  mapping = c(coastal_flows = 'coastal-flows', sim_length = 'sim-length'),
  agents_after = list(
    individuals = agent_set(
      vars = c('name', 'population'),
      agents = 'cities'
    )
  ),
  random_seed = 1
)  
```

```{r}
result <- nl_run(experiment, parallel = T)
```

```{r}
cities <- read.csv('data/NA_cities.csv') %>%
  mutate(population = 41.834 * Size ^ 1.3361) %>%
  select(Name, population) %>%
  filter(!is.na(population)) %>%
  mutate(pop_normalized = population / mean(population)) %>%
  select(-population)
```

```{r}
results <- nl_get_result(result, type = 'agents_after', sub_type = 'individuals') %>%
  select(-run_id) %>%
  right_join(cities, by = c('name' = 'Name')) %>%
  mutate(abs.error = abs(population - pop_normalized)) %>%
  group_by(coastal_flows, sim_length, alpha, beta) %>%
  summarise(mae = mean(sq.error))
```


```{r}
ggplot(results, aes(mae)) + geom_density()

qplot(as.factor(sim_length), mae, data = results, geom = 'boxplot')
qplot(as.factor(alpha), mae, data = results, geom = 'boxplot')
qplot(as.factor(beta), mae, data = results, geom = 'boxplot')
qplot(as.factor(coastal_flows), mae, data = results, geom = 'boxplot')
```


```{r}
results %>%
  filter(coastal_flows == .1, sim_length == 100) %>%
ggplot(aes(alpha, beta, fill = mae)) +
  geom_raster()
```


```{r}
results %>%
  filter(mae < 2) %>%
  ggplot(aes(sim_length)) + geom_density()
```

