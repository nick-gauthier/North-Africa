---
title: "Potential PFT"
output: html_notebook
---

```{r}
library(tidyverse)
library(raster)
library(mgcv)
```


```{r}
library(ncdf4)
pft <- nc_open('~/Downloads/mksrf_pft_potv.nc') #%>% ncvar_get(varid = 'PCT_PFT')
pft
test <- pft %>% brick(xmn = -180, xmx = 180, ymn = -90, ymx = 90, transpose = F)
rasterVis::levelplot(test[[1]])
lat <- ncvar_get(pft, varid = 'LAT')
lon <- ncvar_get(pft, varid = 'LON')
nc_close(pft)
vals <- brick('~/Downloads/mksrf_pft_potv.nc') %>% getValues
landmask <- raster('~/Downloads/mksrf_pft_potv.nc', varname = 'LANDMASK') 
plot(landmask)
landmask <- landmask %>% getValues %>% setValues(temp[[1]], .)
landmask[landmask == 0] <- NA
crs(landmask) <- "+proj=longlat +datum=WGS84"
#Generate coordinates for each grid cell
 x<- rep(lon, length(lat))
 y<- rep(lat, each = length(lon))
 sp<- SpatialPoints(cbind(x,y))
temp<- SpatialPixels(points = sp) %>% raster %>% brick(rep(., 12))
test <- setValues(temp, vals) %>% mask(landmask)
crs(test) <- "+proj=longlat +datum=WGS84" 

rasterVis::levelplot(test)

pft
plot(pft[[1]])
```

```{r}
wc <- raster::getData('worldclim', var = 'bio', res = 5) %>% 
  aggregate(fact = 6) %>%
  crop(bbox) %>%
  mask(landmask %>% crop(bbox))

pft <- test %>% crop(bbox)
```


```{r}
biomes <- readxl::read_excel('BIOME4-2.xls', sheet = 2) %>% 
  dplyr::select(Lon, Lat, biome = MegaBiome00k) %>%
  filter(!is.na(biome)) %>%
  mutate(biome.int = biome %>% as.factor %>% as.numeric %>% `-`(1))
plot(biomes$Lon,biomes$Lat)
```
```{r}
unique(biomes$biome.int)
dat <- raster::extract(wc, biomes[,1:2], na.rm = T, df = T) %>% cbind(biomes, .)


mod1 <- gam(list(biome.int ~ s(bio1, bs = 'cr') + s(bio2, bs = 'cr') + s(bio3, bs = 'cr') + s(bio4, bs = 'cr') + s(bio5, bs = 'cr') + s(bio6, bs = 'cr') + s(bio7, bs = 'cr') + s(bio8, bs = 'cr') + s(bio9, bs = 'cr') + s(bio10, bs = 'cr') + s(bio11, bs = 'cr') + s(bio12, bs = 'cr') + s(bio13, bs = 'cr') + s(bio14, bs = 'cr') + s(bio15, bs = 'cr') + s(bio16, bs = 'cr') + s(bio17, bs = 'cr') + s(bio18, bs = 'cr') + s(bio19, bs = 'cr'),
                 ~ s(bio1, bs = 'cr') + s(bio2, bs = 'cr') + s(bio3, bs = 'cr') + s(bio4, bs = 'cr') + s(bio5, bs = 'cr') + s(bio6, bs = 'cr') + s(bio7, bs = 'cr') + s(bio8, bs = 'cr') + s(bio9, bs = 'cr') + s(bio10, bs = 'cr') + s(bio11, bs = 'cr') + s(bio12, bs = 'cr') + s(bio13, bs = 'cr') + s(bio14, bs = 'cr') + s(bio15, bs = 'cr') + s(bio16, bs = 'cr') + s(bio17, bs = 'cr') + s(bio18, bs = 'cr') + s(bio19, bs = 'cr'),
                 ~ s(bio1, bs = 'cr') + s(bio2, bs = 'cr') + s(bio3, bs = 'cr') + s(bio4, bs = 'cr') + s(bio5, bs = 'cr') + s(bio6, bs = 'cr') + s(bio7, bs = 'cr') + s(bio8, bs = 'cr') + s(bio9, bs = 'cr') + s(bio10, bs = 'cr') + s(bio11, bs = 'cr') + s(bio12, bs = 'cr') + s(bio13, bs = 'cr') + s(bio14, bs = 'cr') + s(bio15, bs = 'cr') + s(bio16, bs = 'cr') + s(bio17, bs = 'cr') + s(bio18, bs = 'cr') + s(bio19, bs = 'cr'),
                 ~ s(bio1, bs = 'cr') + s(bio2, bs = 'cr') + s(bio3, bs = 'cr') + s(bio4, bs = 'cr') + s(bio5, bs = 'cr') + s(bio6, bs = 'cr') + s(bio7, bs = 'cr') + s(bio8, bs = 'cr') + s(bio9, bs = 'cr') + s(bio10, bs = 'cr') + s(bio11, bs = 'cr') + s(bio12, bs = 'cr') + s(bio13, bs = 'cr') + s(bio14, bs = 'cr') + s(bio15, bs = 'cr') + s(bio16, bs = 'cr') + s(bio17, bs = 'cr') + s(bio18, bs = 'cr') + s(bio19, bs = 'cr'),
                 ~ s(bio1, bs = 'cr') + s(bio2, bs = 'cr') + s(bio3, bs = 'cr') + s(bio4, bs = 'cr') + s(bio5, bs = 'cr') + s(bio6, bs = 'cr') + s(bio7, bs = 'cr') + s(bio8, bs = 'cr') + s(bio9, bs = 'cr') + s(bio10, bs = 'cr') + s(bio11, bs = 'cr') + s(bio12, bs = 'cr') + s(bio13, bs = 'cr') + s(bio14, bs = 'cr') + s(bio15, bs = 'cr') + s(bio16, bs = 'cr') + s(bio17, bs = 'cr') + s(bio18, bs = 'cr') + s(bio19, bs = 'cr'),
                 ~ s(bio1, bs = 'cr') + s(bio2, bs = 'cr') + s(bio3, bs = 'cr') + s(bio4, bs = 'cr') + s(bio5, bs = 'cr') + s(bio6, bs = 'cr') + s(bio7, bs = 'cr') + s(bio8, bs = 'cr') + s(bio9, bs = 'cr') + s(bio10, bs = 'cr') + s(bio11, bs = 'cr') + s(bio12, bs = 'cr') + s(bio13, bs = 'cr') + s(bio14, bs = 'cr') + s(bio15, bs = 'cr') + s(bio16, bs = 'cr') + s(bio17, bs = 'cr') + s(bio18, bs = 'cr') + s(bio19, bs = 'cr'),
                 ~ s(bio1, bs = 'cr') + s(bio2, bs = 'cr') + s(bio3, bs = 'cr') + s(bio4, bs = 'cr') + s(bio5, bs = 'cr') + s(bio6, bs = 'cr') + s(bio7, bs = 'cr') + s(bio8, bs = 'cr') + s(bio9, bs = 'cr') + s(bio10, bs = 'cr') + s(bio11, bs = 'cr') + s(bio12, bs = 'cr') + s(bio13, bs = 'cr') + s(bio14, bs = 'cr') + s(bio15, bs = 'cr') + s(bio16, bs = 'cr') + s(bio17, bs = 'cr') + s(bio18, bs = 'cr') + s(bio19, bs = 'cr'),
                 ~ s(bio1, bs = 'cr') + s(bio2, bs = 'cr') + s(bio3, bs = 'cr') + s(bio4, bs = 'cr') + s(bio5, bs = 'cr') + s(bio6, bs = 'cr') + s(bio7, bs = 'cr') + s(bio8, bs = 'cr') + s(bio9, bs = 'cr') + s(bio10, bs = 'cr') + s(bio11, bs = 'cr') + s(bio12, bs = 'cr') + s(bio13, bs = 'cr') + s(bio14, bs = 'cr') + s(bio15, bs = 'cr') + s(bio16, bs = 'cr') + s(bio17, bs = 'cr') + s(bio18, bs = 'cr') + s(bio19, bs = 'cr')), 
            family = multinom(K = 8), data = dat, select = T)
```

```{r}
srtm <- raster('~/gdrive/Data/SRTM_1km.tif')

elev <- srtm %>% aggregate(pft)
```

