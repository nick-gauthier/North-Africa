---
title: "Mapping Roman North Africa"
author: "Nick"
date: "6/8/2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
```{r}
library(raster)
library(rasterVis)
library(tidyverse)
library(stringr)
library(pleiades)
```

Import SRTM basemap
```{r}
bbox <- extent(-10, 20, 28, 38)
srtm <- raster('Data/SRTM_NE_250m_TIF/SRTM_NE_250m.tif') %>%
  crop(bbox)

slope <- terrain(srtm, unit = 'degrees')

plot(srtm)
```


```{r}
places <- pl_search_places() %>%
  filter(locationPrecision == 'precise') %>%
  select(title, type = featureTypes, description, 
         lon = reprLong, lat = reprLat, 
         periods = timePeriods, minDate, maxDate, id, tags) %>%
  filter(between(lat, 28, 38) & between(lon, -10, 20)) %>%
  collect  %>%
  filter(str_detect(periods, 'R')) %>%
  print


villas <- filter(places, str_detect(type, 'villa'))
mines <- filter(places, str_detect(type, 'mine'))
settlements <- filter(places, str_detect(type,'settlement'))
springs <- filter(places, str_detect(type, 'spring'))
estates <- filter(places, str_detect(type, 'estate'))
oases <- filter(places, str_detect(type, 'oasis'))

major <- settlements %>% filter(str_detect(tags, 'major=1'))

gplot(srtm) +
  geom_raster(aes(fill = value)) +
  geom_point(data = major, aes(x = lon, y = lat)) +
  coord_fixed()

```


```{r}
roads <- readOGR('Roman Road Network (version 2008)/roads/') %>%
  spTransform(CRS('+proj=longlat')) %>%
  crop(extent(-10, 20, 30, 38))

plot(roads)
```


```{r t(ransition}
library(gdistance)

altDiff <- function(x){x[2] - x[1]}
hd <- transition(srtm, altDiff, 8, symm=FALSE)
adj <- adjacent(srtm, cells=1:ncell(srtm), pairs=TRUE, directions=8)
```

Create conductance matrix with geocorrection for lcps
```{r lcp_conductance}
slope.c <- geoCorrection(hd, type = 'c')
speed.c <- slope.c
speed.c[adj] <- 6 * exp(-3.5 * abs(slope.c[adj] + 0.05))
Conductance.c <- geoCorrection(speed.c, type = 'c')
rm(slope.c, speed.c)
```

```{r}
sites <- major %>%
  select(lon, lat) %>%
  as.matrix

acc <- accCost(Conductance.c, sites) %>%
  mask(srtm)

plot(acc/3600<3)
```


Create conductance matrix with geocorrection for random walks
```{r randomwalk_conductance}
slope.r <- geoCorrection(hd, type = 'r', scl =T)
speed.r <- slope.r
speed.r[adj] <- 6 * exp(-3.5 * abs(slope.r[adj] + 0.05))
Conductance.r <- geoCorrection(speed.r, type = 'r', scl = T)
rm(slope.r, speed.r, hd, adj)
```


```{r}
pas <- passage(Conductance.r, sites, sites, theta = 1)
plot(pas)
```

```{r}
plot(c(cost_matrix), c(commute_matrix))
```



