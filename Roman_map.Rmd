---
title: "Mapping Roman North Africa"
author: "Nick Gauthier"
date: 
output: 
  html_document: 
    keep_md: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Import and setup
Load required packages
```{r}
library(raster)
library(rgdal)
library(rasterVis)
library(viridis)
library(tidyverse)
library(stringr)
library(pleiades)
```
Define map extent.
```{r}
bbox <- extent(-10, 20, 28, 38)
bbox <- extent(-4, 18, 30, 38)
```
## Elevation Data
Get country boundaries for spain, portugal, and italy to mask out from elevation
```{r}
euro.mask <- rbind(getData('GADM', country = 'PRT', level = 0),
                   getData('GADM', country = 'ESP', level = 0),
                   getData('GADM', country = 'ITA', level = 0))
```

First download and mosaic 90m srtm tiles over the study area.
```{r}
#getData('SRTM', lon = -8, lat = 35)
#getData('SRTM', lon = -3, lat = 35)
#getData('SRTM', lon = 2, lat = 35)
getData('SRTM', lon = 7, lat = 35)
getData('SRTM', lon = 12, lat = 35, path = 'data/')
#getData('SRTM', lon = -8, lat = 40)
#getData('SRTM', lon = -3, lat = 40)
#getData('SRTM', lon = 2, lat = 40)
getData('SRTM', lon = 7, lat = 40, path = 'data')
getData('SRTM', lon = 12, lat = 40, path = 'data')



srtm <- list.files(pattern = '*.tif', recursive = T) %>% 
  lapply(raster) %>% 
  do.call(merge, .) #%>%
  mask(euro.mask, inverse = T)

writeRaster(srtm, 'srtm_na.tif')
srtm <- raster('data/srtm_na.tif')
```

```{r}
plot(srtm)
```

```{r}
slope <- terrain(srtm, opt = 'slope', filename = 'slope.tif', overwrite = T)
aspect <- terrain(srtm, opt = 'aspect', filename = 'aspect.tif', overwrite = T)
TPI <- terrain(srtm, opt = 'TPI', filename = 'TPI.tif', overwrite = T)
TRI <- terrain(srtm, opt = 'TRI', filename  = 'TRI.tif', overwrite = T)
roughness <- terrain(srtm, opt = 'roughness', filename = 'roughness.tif', overwrite = T)
flowdir <- terrain(srtm, opt = 'flowdir', filename = 'flowdir.tif', overwrite = T)
```

```{r}
plot(slope)
plot(aspect)
plot(TPI)
plot(TRI)
plot(roughness)
plot(flowdir)
```

```{r}
cities <- read.csv('data/NA_cities.csv') %>%
  group_by(BA_rank) %>% 
  mutate(size_est = ifelse(is.na(Size), mean(Size, na.rm=TRUE), Size)) %>%
  mutate(population = 41.834 * Size^1.3361, pop_est = 41.834 * size_est^1.3361) %>%
  filter(between(lat, 30, 38) & between(lon, -4, 18))

max(cities$pop_est)
  coordinates(cities) <- ~lon + lat
shapefile(cities, filename = 'NA_cities')


```



```{r}
roads <- readOGR('data/Shapefiles/ba_roads.shp') %>%
  spTransform(CRS('+proj=longlat')) %>%
  crop(bbox) %>%
  fortify

aqueducts <- readOGR('data/Shapefiles/aqueducts.shp') %>%
  spTransform(CRS('+proj=longlat')) %>%
  crop(bbox)

centuriation <- readOGR('data/Shapefiles/centuriation_polygons.shp') %>%
  spTransform(CRS('+proj=longlat')) %>%
  crop(bbox)
```

```{r}
ggplot(cities, aes(lon, lat)) +
  geom_path(data = roads, aes(long, lat, group = group), color = 'lightgrey') + #alpha = .5) +
  geom_point(aes(size = pop_est * 10)) +
  scale_size_area() +
  #scale_color_viridis() +
  theme_void() +
  coord_fixed() + theme(legend.position="none")

ggsave('roman_network.png')
```

```{r}
with(cities, cities[rep(1:nrow(cities), pop_est),]) %>%
ggplot(aes(lon, lat)) +
  stat_density_2d(aes(fill = ..density..), geom = "raster", contour = F, n = 500, h = 1) +
  geom_path(data = roads, aes(long, lat, group = group), alpha = .5, color = 'white') +
  scale_fill_viridis() +
  coord_fixed() +
  theme_void()
```

```{r}
with(cities, cities[rep(1:nrow(cities), pop_est),]) %>%
ggplot(aes(lon, lat)) +
  stat_density_2d(aes(fill = ..density..), geom = "raster", contour = F, n = 500, h = 1) +
  geom_path(data = centuriation, aes(long, lat, group = group), alpha = .5, color = 'white') +
  scale_fill_viridis() +
  coord_fixed() +
  theme_void()
```

  
```{r}
places <- pl_search_places() %>%
  filter(locationPrecision == 'precise') %>%
  select(title, type = featureTypes, description, 
         lon = reprLong, lat = reprLat, 
         periods = timePeriods, minDate, maxDate, id, tags) %>%
  filter(between(lat, 28, 38) & between(lon, -10, 20)) %>%
  collect  %>%
  filter(str_detect(periods, 'R')) %>%
  print

places %>% filter(str_detect(type, 'villa'))
ggplot(aes(lon, lat)) +
  stat_density_2d(aes(fill = ..density..), geom = "raster", contour = F, n = 500, h = 1) +
  geom_path(data = roads, aes(long, lat, group = group), alpha = .5, color = 'white') +
  scale_fill_viridis() +
  coord_fixed() +
  theme_void()

places %>% filter(str_detect(type, 'settlement')) %>%
ggplot(aes(lon, lat)) +
  stat_density_2d(aes(fill = ..density..), geom = "raster", contour = F, n = 500, h = 1) +
  geom_path(data = roads, aes(long, lat, group = group), alpha = .5, color = 'white') +
  scale_fill_viridis() +
  coord_fixed() +
  theme_void()

places %>% filter(str_detect(type, 'mine')) %>%
ggplot(aes(lon, lat)) +
  stat_density_2d(aes(fill = ..density..), geom = "raster", contour = F, n = 500, h = 1) +
  geom_path(data = roads, aes(long, lat, group = group), alpha = .5, color = 'white') +
  scale_fill_viridis() +
  coord_fixed() +
  theme_void()

places %>% filter(str_detect(type, 'spring')) %>%
ggplot(aes(lon, lat)) +
  stat_density_2d(aes(fill = ..density..), geom = "raster", contour = F, n = 500, h = 1) +
  geom_path(data = roads, aes(long, lat, group = group), alpha = .5, color = 'white') +
  scale_fill_viridis() +
  coord_fixed() +
  theme_void()

places %>% filter(str_detect(type, 'oasis')) %>%
ggplot(aes(lon, lat)) +
  stat_density_2d(aes(fill = ..density..), geom = "raster", contour = F, n = 500, h = 1) +
  geom_path(data = roads, aes(long, lat, group = group), alpha = .5, color = 'white') +
  scale_fill_viridis() +
  coord_fixed() +
  theme_void()


places %>% filter(str_detect(type, 'settlement')) %>%
ggplot(aes(lon, lat)) +
  stat_density_2d(aes(fill = ..density..), geom = "raster", contour = F, n = 500, h = 1) +
  geom_path(data = roads, aes(long, lat, group = group), alpha = .5, color = 'white') +
  scale_fill_viridis() +
  coord_fixed() +
  theme_void() +
  geom_point(data = cities, aes(lon, lat, size = pop_est), color = 'white') +
  scale_size_area()
```
Reproject and save out shapefile
```{r}
settlements <- places %>% filter(str_detect(type, 'settlement'))
coordinates(settlements) <- ~lon + lat
proj4string(settlements) <- '+proj=longlat'
settlements <- spTransform(settlements, CRS("+proj=lcc +lat_1=43 +lat_2=62 +lat_0=30 +lon_0=10 +x_0=0 +y_0=0 +ellps=intl +units=m +no_defs"))

shapefile(settlements, filename = 'data/netlogo/settlements')
```


Compare to environmental covariates
```{r, eval=FALSE, include=FALSE}
srtm <- raster('Data/SRTM_NE_250m_TIF/SRTM_NE_250m.tif') %>%
  crop(bbox)

slope <- terrain(srtm, opt = 'slope', unit = 'degrees')
aspect <- terrain(srtm, opt = 'aspect', unit = 'degrees')
TPI <- terrain(srtm, opt = 'TPI')
TRI <- terrain(srtm, opt = 'TRI')
roughness <- terrain(srtm, opt = 'roughness')
hill <- hillShade(slope, aspect, 40, 270)

topo <- brick(c(srtm, slope, aspect, TPI, TRI, roughness))
rm(srtm, slope, aspect, TPI, TRI, roughness)

plot(slope<9)
```

```{r eval=FALSE, include=FALSE}
prec <- brick('Data/CHELSA/prec.nc') %>% crop(bbox) %>% sum %>% resample(topo)
levelplot(prec)

env <- topo %>% raster::extract(cities[,8:9], df = T) %>% gather(key, value) %>% filter(key !='ID')

ggplot(env, aes(x = key, y = value)) +
  geom_boxplot()
```




```{r eval=FALSE, include=FALSE}
library(gdistance)
srtm <- raster('data/netlogo/elev.asc')
projection(srtm) <- '+proj=lcc +lat_1=43 +lat_2=62 +lat_0=30 +lon_0=10 +x_0=0 +y_0=0 +ellps=intl +units=m +no_defs'


altDiff <- function(x){x[2] - x[1]}
hd <- transition(srtm, altDiff, 16, symm=FALSE)
cell.targets <- Which(!is.na(srtm), cells = T)
adj <- adjacent(srtm, cells=cell.targets, target = cell.targets, pairs=TRUE, directions=16)
```

Create conductance matrix with geocorrection for lcps
```{r lcp_conductance, eval=FALSE, include=FALSE}
slope.c <- geoCorrection(hd, type = 'c')
speed.c <- slope.c
speed.c[adj] <- 6 * exp(-3.5 * abs(slope.c[adj] + 0.05))
Conductance.c <- geoCorrection(speed.c, type = 'c')

test <- rowColFromCell(srtm, Which(srtm < 1000, cells = T))
test[,2] <- test[,2] - 1
test[,1] <- test[,1] * -1 + max(test[,1])
test
as.list(data.frame(t(test)))
rm(slope.c, speed.c)
```

```{r eval=FALSE, include=FALSE}
sites <- major %>%
  select(lon, lat) %>%
  as.matrix

acc <- accCost(Conductance.c, sites) %>%
  mask(srtm)

plot(acc/3600<3)
```


Create conductance matrix with geocorrection for random walks
```{r randomwalk_conductance, eval=FALSE, include=FALSE}
slope.r <- geoCorrection(hd, type = 'r', scl =T)
speed.r <- slope.r
speed.r[adj] <- 6 * exp(-3.5 * abs(slope.r[adj] + 0.05))
Conductance.r <- geoCorrection(speed.r, type = 'r', scl = T)
rm(slope.r, speed.r, hd, adj)
```


```{r, eval=FALSE, include=FALSE}
pas <- passage(Conductance.r, sites, sites, theta = 1)
plot(pas)
```

```{r, eval=FALSE, include=FALSE}
plot(c(cost_matrix), c(commute_matrix))
```



